name: Build VPinFE (Cross-Platform)

on:
  push:
    branches: [ master, vpinfe-chromium, vpinfe-pyside6 ]
  pull_request:
    branches: [ master, vpinfe-chromium, vpinfe-pyside6]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Set up Python 3.14
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.14'

      # 3. Install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

   
      # 4. Build Linux slim variant (no bundled Chromium - uses system chromium)
      - name: Build slim app with PyInstaller (Linux)
        if: runner.os == 'Linux'
        run: |
          rm -rf build dist
          pyinstaller --onedir --noconfirm --name vpinfe \
            --add-data "web:web" \
            --add-data "managerui/static:managerui/static" \
            --hidden-import pynput.keyboard._xorg \
            --hidden-import pynput.mouse._xorg \
            main.py
        shell: bash

      - name: Upload slim build artifact (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-Linux-slim
          path: dist/

      # 5. Build Windows slim variant (no bundled Chromium - uses system Chrome/Chromium)
      - name: Build slim app with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force build, dist -ErrorAction SilentlyContinue
          pyinstaller --onedir --noconfirm --name vpinfe `
            --add-data "web;web" `
            --add-data "managerui/static;managerui/static" `
            main.py

      - name: Copy Windows launcher (slim)
        if: runner.os == 'Windows'
        run: cp vpinfe.bat dist/vpinfe/
        shell: bash

      - name: Upload slim build artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-Windows-slim
          path: dist/

      # 6. Build macOS slim variant (no bundled Chromium - uses system Chrome/Chromium)
      - name: Build slim app with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          rm -rf build dist
          pyinstaller --windowed -i icon/VPinFE.icns --osx-bundle-identifier com.vpinfe.main --noconfirm --name VPinFE \
            --add-data "web:web" \
            --add-data "managerui/static:managerui/static" \
            main.py
           #remove build directory
          rm -rf dist/vpinfe
        shell: bash
      #7. Ad-hoc sign the app bundle
      #    This prevents the "app is damaged" error and satisfies basic structural
      #    signing requirements. Users will still need to allow the app via
      #    System Settings > Privacy & Security > "Open Anyway" on first launch.
      - name: Ad-hoc sign the app (macOS Slim)
        if: runner.os == 'macOS'
        run: |
          codesign --force --deep --sign - dist/VPinFE.app
          echo "Signing exit code: $?"
          codesign --verify --verbose dist/VPinFE.app
        shell: bash

      #8. Remove extended attributes from the artifact before packaging
      - name: Remove extended attributes (macOS Slim)
        if: runner.os == 'macOS'
        run: |
          sudo xattr -rc dist
          echo "xattr exit code: $?"
        shell: bash
      #9. Create DMG
      - name: Package as DMG (macOS Slim)
        if: runner.os == 'macOS'
        run: |
          create-dmg \
            --volname "VPinFE" \
            --volicon "icon/VPinFE.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "VPinFE.app" 175 190 \
            --hide-extension "VPinFE.app" \
            --app-drop-link 425 190 \
            "dist/VPinFE.dmg" \
            "dist/VPinFE.app"
        shell: bash
       #10 Upload artifact
      - name: Upload slim build artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: vpinfe-macOS-slim
          path: dist/VPinFE.dmg

